# Unified MCP Infrastructure - Docker Compose
# All MCP servers in one place
version: '3.8'

services:
  # ============================================
  # TRADING CLUSTER (5 servers)
  # ============================================
  
  pricing-greeks:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/trading/pricing_greeks/Dockerfile
    container_name: axiom-mcp-pricing-greeks
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=pricing-greeks
      - MCP_SERVER_VERSION=1.0.0
      - MCP_TRANSPORT=http
      - MCP_PORT=8100
    ports:
      - "8100:8100"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8100/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  portfolio-risk:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/trading/portfolio_risk/Dockerfile
    container_name: axiom-mcp-portfolio-risk
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=portfolio-risk
      - MCP_TRANSPORT=http
      - MCP_PORT=8101
    ports:
      - "8101:8101"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8101/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  strategy-gen:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/trading/strategy_gen/Dockerfile
    container_name: axiom-mcp-strategy-gen
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=strategy-gen
      - MCP_TRANSPORT=http
      - MCP_PORT=8102
    ports:
      - "8102:8102"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8102/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  execution:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/trading/execution/Dockerfile
    container_name: axiom-mcp-execution
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=execution
      - MCP_TRANSPORT=http
      - MCP_PORT=8103
    ports:
      - "8103:8103"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8103/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  hedging:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/trading/hedging/Dockerfile
    container_name: axiom-mcp-hedging
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=hedging
      - MCP_TRANSPORT=http
      - MCP_PORT=8104
    ports:
      - "8104:8104"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8104/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # ANALYTICS CLUSTER (3 servers)
  # ============================================

  performance:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/analytics/performance/Dockerfile
    container_name: axiom-mcp-performance
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=performance
      - MCP_TRANSPORT=http
      - MCP_PORT=8105
    ports:
      - "8105:8105"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8105/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  market-data:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/analytics/market_data/Dockerfile
    container_name: axiom-mcp-market-data
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=market-data
      - MCP_TRANSPORT=http
      - MCP_PORT=8106
    ports:
      - "8106:8106"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8106/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  volatility:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/analytics/volatility/Dockerfile
    container_name: axiom-mcp-volatility
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=volatility
      - MCP_TRANSPORT=http
      - MCP_PORT=8107
    ports:
      - "8107:8107"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8107/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # COMPLIANCE CLUSTER (1 server)
  # ============================================

  regulatory:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/public/compliance/regulatory/Dockerfile
    container_name: axiom-mcp-regulatory
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=regulatory
      - MCP_TRANSPORT=http
      - MCP_PORT=8108
    ports:
      - "8108:8108"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8108/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # INTERNAL SERVERS (3 servers)
  # ============================================

  system-health:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/internal/monitoring/system_health/Dockerfile
    container_name: axiom-mcp-system-health
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=system-health
      - MCP_TRANSPORT=http
      - MCP_PORT=8109
    ports:
      - "8109:8109"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8109/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  guardrails:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/internal/safety/guardrails/Dockerfile
    container_name: axiom-mcp-guardrails
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=guardrails
      - MCP_TRANSPORT=http
      - MCP_PORT=8110
    ports:
      - "8110:8110"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8110/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  interface:
    build:
      context: ../..
      dockerfile: axiom/mcp/servers/internal/client/interface/Dockerfile
    container_name: axiom-mcp-interface
    environment:
      - PYTHONPATH=/app
      - MCP_SERVER_NAME=interface
      - MCP_TRANSPORT=http
      - MCP_PORT=8111
    ports:
      - "8111:8111"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8111/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  mcp-network:
    driver: bridge
    name: axiom-mcp-network

# Usage:
# Start all servers:        docker-compose up -d
# Start specific cluster:   docker-compose up -d pricing-greeks portfolio-risk strategy-gen execution hedging
# View logs:                docker-compose logs -f pricing-greeks
# Stop all:                 docker-compose down
# Rebuild and start:        docker-compose up -d --build