version: '3.8'

services:
  # RAG API Service
  # Uses existing Neo4j, PostgreSQL, and Redis from database_axiom_network
  rag_api:
    build:
      context: ../../..
      dockerfile: axiom/models/rag/Dockerfile
    container_name: axiom-rag-api
    ports:
      - "8002:8000"  # Changed to avoid conflicts
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      # Use existing Neo4j
      - NEO4J_URI=bolt://axiom-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      # Use existing PostgreSQL
      - POSTGRES_HOST=axiom-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=axiom_finance
      - POSTGRES_USER=axiom
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # ChromaDB local storage
      - CHROMA_PERSIST_DIRECTORY=/app/data/chroma
      - PYTHONUNBUFFERED=1
    volumes:
      - chroma_data:/app/data/chroma
      - upload_data:/app/data/uploads
    networks:
      - database_axiom_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Note: Using existing Prometheus and Grafana from monitoring stack
# No need to duplicate - metrics available at existing endpoints

volumes:
  chroma_data:
    driver: local
  upload_data:
    driver: local

networks:
  database_axiom_network:
    external: true