# Centralized DAG Configuration
# All schedules, thresholds, and parameters are configurable here

# ================================================================
# Global Settings
# ================================================================
global:
  owner: axiom
  email:
    - admin@axiom.com
  email_on_failure: false  # SMTP not configured
  email_on_retry: false
  catchup: false
  max_active_runs: 1
  
  # Default retry settings
  retries: 3
  retry_delay_minutes: 5
  
  # Database connections (environment variables will be used at runtime)
  postgres:
    host_env: POSTGRES_HOST
    user_env: POSTGRES_USER
    password_env: POSTGRES_PASSWORD
    database_env: POSTGRES_DB
  
  redis:
    host_env: REDIS_HOST
    password_env: REDIS_PASSWORD
  
  neo4j:
    uri_env: NEO4J_URI
    user_env: NEO4J_USER
    password_env: NEO4J_PASSWORD

# ================================================================
# Market Data Symbols (shared across DAGs)
# ================================================================
symbols:
  primary:
    - AAPL
    - MSFT
    - GOOGL
    - TSLA
    - NVDA
    - AMZN
    - META
    - NFLX
  
  extended:
    - GOOG
    - CRM
    - ORCL
    - ADBE
    - INTC
    - AMD
    - QCOM
    - AVGO
    - CSCO
    - TXN
    - UBER
    - LYFT
    - SNAP
    - JPM
    - BAC
    - GS
    - MS

# ================================================================
# Data Ingestion DAG Configuration
# ================================================================
data_ingestion:
  dag_id: data_ingestion_v2
  description: "Real-time data with multi-source failover - NO per-trigger validation"
  
  # Schedule: Every minute for real-time ingestion
  schedule_interval: "*/1 * * * *"
  execution_timeout_minutes: 5
  
  # Multi-source failover configuration
  data_sources:
    primary: yahoo
    fallback:
      - polygon
      - finnhub
  
  # Circuit breaker settings
  circuit_breaker:
    failure_threshold: 5
    recovery_timeout_seconds: 60
  
  # Cache settings
  cache_ttl_minutes: 5
  
  # Storage settings
  parallel_storage: true  # Store to PostgreSQL, Redis, Neo4j simultaneously
  
  # REMOVED: trigger_validation (moved to batch validation)
  # NO per-trigger validation - batch validation handles this now
  
  tags:
    - v2
    - enterprise
    - real-time
    - multi-source
    - failover

# ================================================================
# Data Quality Validation DAG Configuration
# BATCH VALIDATION: Processes 5-minute windows
# ================================================================
data_quality_validation:
  dag_id: data_quality_validation
  description: "Batch validation of 5-minute windows (no per-trigger)"
  
  # Schedule: Every 5 minutes for batch validation
  schedule_interval: "*/5 * * * *"
  execution_timeout_minutes: 10
  
  # Batch validation settings
  batch:
    enabled: true
    window_minutes: 5  # Validate 5-minute windows instead of per-trigger
    min_records_to_validate: 1  # Only validate if at least 1 new record
  
  # Validation thresholds
  thresholds:
    data_freshness_minutes: 120  # Data must be < 2 hours old
    min_symbols_with_recent_data: 10
    max_duplicate_tolerance: 0
    price_min: 0.01
    price_max: 100000
    volume_max: 1000000000000
    max_intraday_movement_percent: 50
  
  # Quality checks configuration
  quality_checks:
    record_level:
      - high_low_check
      - close_within_range
      - positive_values
      - reasonable_movement
      - timestamp_validity
    
    database_level:
      - data_freshness
      - symbol_completeness
      - no_duplicates
      - price_reasonableness
    
    sql_based:
      - hourly_data_count
      - no_stale_data
      - volume_sanity
  
  # Alert settings
  alerts:
    enabled: true
    fail_on_error: false  # Log warnings, don't fail DAG
    min_success_rate_percent: 95
  
  tags:
    - quality
    - validation
    - batch
    - 5-min-windows

# ================================================================
# Company Graph Builder DAG Configuration
# ================================================================
company_graph_builder:
  dag_id: company_graph_builder_v2
  description: "Build company graph with enterprise operators"
  
  # Schedule: Every 5 minutes for active monitoring
  schedule_interval: "*/5 * * * *"
  execution_timeout_minutes: 30
  
  # Claude caching for cost optimization
  claude:
    cache_ttl_hours: 24
    track_cost: true
    max_tokens: 4096
  
  # Circuit breaker settings
  circuit_breaker:
    failure_threshold: 5
    recovery_timeout_seconds: 300
  
  # Neo4j bulk operations
  neo4j:
    batch_size: 1000
    validation:
      min_nodes: 20
      min_relationships: 50
      check_orphans: true
      fail_on_error: false
  
  # Use extended symbol list for comprehensive graph
  symbols_list: extended
  
  tags:
    - v2
    - enterprise
    - claude-cached
    - neo4j
    - cost-optimized

# ================================================================
# Correlation Analyzer DAG Configuration
# ================================================================
correlation_analyzer:
  dag_id: correlation_analyzer_v2
  description: "Correlation analysis with cached explanations"
  
  # Schedule: Every 5 minutes for active monitoring
  schedule_interval: "*/5 * * * *"
  execution_timeout_minutes: 20
  
  # Correlation settings
  correlation:
    lookback_days: 30
    min_data_points: 20
    significance_threshold: 0.5  # Lower threshold for more relationships
    top_n_correlations: 20
  
  # Claude caching (correlations very stable)
  claude:
    cache_ttl_hours: 48  # Extended cache for stable data
    track_cost: true
    max_tokens: 2048
  
  # Circuit breaker settings
  circuit_breaker:
    failure_threshold: 3
    recovery_timeout_seconds: 60
  
  # Data quality requirements
  quality:
    min_recent_symbols: 10
    max_null_percent: 0
  
  # Use primary symbol list
  symbols_list: primary
  
  tags:
    - v2
    - enterprise
    - correlation
    - claude-cached
    - quant

# ================================================================
# Events Tracker DAG Configuration
# ================================================================
events_tracker:
  dag_id: events_tracker_v2
  description: "Track market events with cached Claude classification"
  
  # Schedule: Every 15 minutes (reasonable for news tracking)
  schedule_interval: "*/15 * * * *"
  execution_timeout_minutes: 10
  retries: 2
  retry_delay_minutes: 2
  
  # News fetching settings
  news:
    max_items_per_symbol: 5
    sources:
      - yfinance
  
  # Event classification settings
  event_types:
    - earnings
    - product_launch
    - regulatory
    - acquisition
    - leadership_change
    - other
  
  sentiments:
    - positive
    - negative
    - neutral
  
  impact_levels:
    - high
    - medium
    - low
  
  # Claude caching (news repeated across sources)
  claude:
    cache_ttl_hours: 6
    track_cost: true
    max_tokens: 4096
  
  # Circuit breaker settings
  circuit_breaker:
    failure_threshold: 5
    recovery_timeout_seconds: 120
  
  # Neo4j batch operations
  neo4j:
    batch_create: true
  
  # Use primary symbol list
  symbols_list: primary
  
  tags:
    - v2
    - enterprise
    - events
    - claude-cached
    - cost-optimized

# ================================================================
# Cost Tracking Configuration
# ================================================================
cost_tracking:
  enabled: true
  postgres_table: claude_usage_tracking
  track_metrics:
    - api_calls
    - tokens_input
    - tokens_output
    - cost_per_call
    - cache_hit_rate
    - execution_time

# ================================================================
# Monitoring & Alerting
# ================================================================
monitoring:
  sla_minutes: 45
  
  # Performance thresholds
  performance:
    data_ingestion_max_seconds: 10
    validation_max_seconds: 60
    graph_builder_max_seconds: 300
    correlation_max_seconds: 120
    events_max_seconds: 60
  
  # Success rate thresholds
  success_rates:
    data_ingestion_min_percent: 99.9
    validation_min_percent: 95
    graph_builder_min_percent: 90
    correlation_min_percent: 90
    events_min_percent: 85